/* Copyright (C) RSA Data Security, Inc. created 1987.  This is an
   unpublished work protected as such under copyright law.  This work
   contains proprietary, confidential, and trade secret information of
   RSA Data Security, Inc.  Use, disclosure or reproduction without the
   express written authorization of RSA Data Security, Inc. is
   prohibited.
 */

#include "global.h"
#include "algae.h"
#include "des.h"

/* Define INTELx86 for x86 and other CPUs that can convert */
/* a string of 4 characters into a long with an assignment. */

/* Copyright (C) 1993 Eric Young
 * 1.4 Speed up by 400% :-)
 * 1.3 added register declarations.
 * 1.2 unrolled make_key_sched a bit more
 * 1.1 added norm_expand_bits
 * 1.0 First working version
 */

/* spr.h */
/* Copyright (C) 1993 Eric Young */
static UINT4 des_SPtrans[8][64]={
  /* nibble 0 */
  {  
    0x00820200l, 0x00020000l, 0x80800000l, 0x80820200l,
    0x00800000l, 0x80020200l, 0x80020000l, 0x80800000l,
    0x80020200l, 0x00820200l, 0x00820000l, 0x80000200l,
    0x80800200l, 0x00800000l, 0x00000000l, 0x80020000l,
    0x00020000l, 0x80000000l, 0x00800200l, 0x00020200l,
    0x80820200l, 0x00820000l, 0x80000200l, 0x00800200l,
    0x80000000l, 0x00000200l, 0x00020200l, 0x80820000l,
    0x00000200l, 0x80800200l, 0x80820000l, 0x00000000l,
    0x00000000l, 0x80820200l, 0x00800200l, 0x80020000l,
    0x00820200l, 0x00020000l, 0x80000200l, 0x00800200l,
    0x80820000l, 0x00000200l, 0x00020200l, 0x80800000l,
    0x80020200l, 0x80000000l, 0x80800000l, 0x00820000l,
    0x80820200l, 0x00020200l, 0x00820000l, 0x80800200l,
    0x00800000l, 0x80000200l, 0x80020000l, 0x00000000l,
    0x00020000l, 0x00800000l, 0x80800200l, 0x00820200l,
    0x80000000l, 0x80820000l, 0x00000200l, 0x80020200l,
  },
  /* nibble 1 */
  {
    0x10042004l, 0x00000000l, 0x00042000l, 0x10040000l,
    0x10000004l, 0x00002004l, 0x10002000l, 0x00042000l,
    0x00002000l, 0x10040004l, 0x00000004l, 0x10002000l,
    0x00040004l, 0x10042000l, 0x10040000l, 0x00000004l,
    0x00040000l, 0x10002004l, 0x10040004l, 0x00002000l,
    0x00042004l, 0x10000000l, 0x00000000l, 0x00040004l,
    0x10002004l, 0x00042004l, 0x10042000l, 0x10000004l,
    0x10000000l, 0x00040000l, 0x00002004l, 0x10042004l,
    0x00040004l, 0x10042000l, 0x10002000l, 0x00042004l,
    0x10042004l, 0x00040004l, 0x10000004l, 0x00000000l,
    0x10000000l, 0x00002004l, 0x00040000l, 0x10040004l,
    0x00002000l, 0x10000000l, 0x00042004l, 0x10002004l,
    0x10042000l, 0x00002000l, 0x00000000l, 0x10000004l,
    0x00000004l, 0x10042004l, 0x00042000l, 0x10040000l,
    0x10040004l, 0x00040000l, 0x00002004l, 0x10002000l,
    0x10002004l, 0x00000004l, 0x10040000l, 0x00042000l,
  },
  /* nibble 2 */
  {
    0x41000000l, 0x01010040l, 0x00000040l, 0x41000040l,
    0x40010000l, 0x01000000l, 0x41000040l, 0x00010040l,
    0x01000040l, 0x00010000l, 0x01010000l, 0x40000000l,
    0x41010040l, 0x40000040l, 0x40000000l, 0x41010000l,
    0x00000000l, 0x40010000l, 0x01010040l, 0x00000040l,
    0x40000040l, 0x41010040l, 0x00010000l, 0x41000000l,
    0x41010000l, 0x01000040l, 0x40010040l, 0x01010000l,
    0x00010040l, 0x00000000l, 0x01000000l, 0x40010040l,
    0x01010040l, 0x00000040l, 0x40000000l, 0x00010000l,
    0x40000040l, 0x40010000l, 0x01010000l, 0x41000040l,
    0x00000000l, 0x01010040l, 0x00010040l, 0x41010000l,
    0x40010000l, 0x01000000l, 0x41010040l, 0x40000000l,
    0x40010040l, 0x41000000l, 0x01000000l, 0x41010040l,
    0x00010000l, 0x01000040l, 0x41000040l, 0x00010040l,
    0x01000040l, 0x00000000l, 0x41010000l, 0x40000040l,
    0x41000000l, 0x40010040l, 0x00000040l, 0x01010000l,
  },
  /* nibble 3 */
  {
    0x00100402l, 0x04000400l, 0x00000002l, 0x04100402l,
    0x00000000l, 0x04100000l, 0x04000402l, 0x00100002l,
    0x04100400l, 0x04000002l, 0x04000000l, 0x00000402l,
    0x04000002l, 0x00100402l, 0x00100000l, 0x04000000l,
    0x04100002l, 0x00100400l, 0x00000400l, 0x00000002l,
    0x00100400l, 0x04000402l, 0x04100000l, 0x00000400l,
    0x00000402l, 0x00000000l, 0x00100002l, 0x04100400l,
    0x04000400l, 0x04100002l, 0x04100402l, 0x00100000l,
    0x04100002l, 0x00000402l, 0x00100000l, 0x04000002l,
    0x00100400l, 0x04000400l, 0x00000002l, 0x04100000l,
    0x04000402l, 0x00000000l, 0x00000400l, 0x00100002l,
    0x00000000l, 0x04100002l, 0x04100400l, 0x00000400l,
    0x04000000l, 0x04100402l, 0x00100402l, 0x00100000l,
    0x04100402l, 0x00000002l, 0x04000400l, 0x00100402l,
    0x00100002l, 0x00100400l, 0x04100000l, 0x04000402l,
    0x00000402l, 0x04000000l, 0x04000002l, 0x04100400l,
  },
  /* nibble 4 */
  {
    0x02000000l, 0x00004000l, 0x00000100l, 0x02004108l,
    0x02004008l, 0x02000100l, 0x00004108l, 0x02004000l,
    0x00004000l, 0x00000008l, 0x02000008l, 0x00004100l,
    0x02000108l, 0x02004008l, 0x02004100l, 0x00000000l,
    0x00004100l, 0x02000000l, 0x00004008l, 0x00000108l,
    0x02000100l, 0x00004108l, 0x00000000l, 0x02000008l,
    0x00000008l, 0x02000108l, 0x02004108l, 0x00004008l,
    0x02004000l, 0x00000100l, 0x00000108l, 0x02004100l,
    0x02004100l, 0x02000108l, 0x00004008l, 0x02004000l,
    0x00004000l, 0x00000008l, 0x02000008l, 0x02000100l,
    0x02000000l, 0x00004100l, 0x02004108l, 0x00000000l,
    0x00004108l, 0x02000000l, 0x00000100l, 0x00004008l,
    0x02000108l, 0x00000100l, 0x00000000l, 0x02004108l,
    0x02004008l, 0x02004100l, 0x00000108l, 0x00004000l,
    0x00004100l, 0x02004008l, 0x02000100l, 0x00000108l,
    0x00000008l, 0x00004108l, 0x02004000l, 0x02000008l,
  },
  /* nibble 5 */
  {
    0x20000010l, 0x00080010l, 0x00000000l, 0x20080800l,
    0x00080010l, 0x00000800l, 0x20000810l, 0x00080000l,
    0x00000810l, 0x20080810l, 0x00080800l, 0x20000000l,
    0x20000800l, 0x20000010l, 0x20080000l, 0x00080810l,
    0x00080000l, 0x20000810l, 0x20080010l, 0x00000000l,
    0x00000800l, 0x00000010l, 0x20080800l, 0x20080010l,
    0x20080810l, 0x20080000l, 0x20000000l, 0x00000810l,
    0x00000010l, 0x00080800l, 0x00080810l, 0x20000800l,
    0x00000810l, 0x20000000l, 0x20000800l, 0x00080810l,
    0x20080800l, 0x00080010l, 0x00000000l, 0x20000800l,
    0x20000000l, 0x00000800l, 0x20080010l, 0x00080000l,
    0x00080010l, 0x20080810l, 0x00080800l, 0x00000010l,
    0x20080810l, 0x00080800l, 0x00080000l, 0x20000810l,
    0x20000010l, 0x20080000l, 0x00080810l, 0x00000000l,
    0x00000800l, 0x20000010l, 0x20000810l, 0x20080800l,
    0x20080000l, 0x00000810l, 0x00000010l, 0x20080010l,
  },
  /* nibble 6 */
  {
    0x00001000l, 0x00000080l, 0x00400080l, 0x00400001l,
    0x00401081l, 0x00001001l, 0x00001080l, 0x00000000l,
    0x00400000l, 0x00400081l, 0x00000081l, 0x00401000l,
    0x00000001l, 0x00401080l, 0x00401000l, 0x00000081l,
    0x00400081l, 0x00001000l, 0x00001001l, 0x00401081l,
    0x00000000l, 0x00400080l, 0x00400001l, 0x00001080l,
    0x00401001l, 0x00001081l, 0x00401080l, 0x00000001l,
    0x00001081l, 0x00401001l, 0x00000080l, 0x00400000l,
    0x00001081l, 0x00401000l, 0x00401001l, 0x00000081l,
    0x00001000l, 0x00000080l, 0x00400000l, 0x00401001l,
    0x00400081l, 0x00001081l, 0x00001080l, 0x00000000l,
    0x00000080l, 0x00400001l, 0x00000001l, 0x00400080l,
    0x00000000l, 0x00400081l, 0x00400080l, 0x00001080l,
    0x00000081l, 0x00001000l, 0x00401081l, 0x00400000l,
    0x00401080l, 0x00000001l, 0x00001001l, 0x00401081l,
    0x00400001l, 0x00401080l, 0x00401000l, 0x00001001l,
  },
  /* nibble 7 */
  {
    0x08200020l, 0x08208000l, 0x00008020l, 0x00000000l,
    0x08008000l, 0x00200020l, 0x08200000l, 0x08208020l,
    0x00000020l, 0x08000000l, 0x00208000l, 0x00008020l,
    0x00208020l, 0x08008020l, 0x08000020l, 0x08200000l,
    0x00008000l, 0x00208020l, 0x00200020l, 0x08008000l,
    0x08208020l, 0x08000020l, 0x00000000l, 0x00208000l,
    0x08000000l, 0x00200000l, 0x08008020l, 0x08200020l,
    0x00200000l, 0x00008000l, 0x08208000l, 0x00000020l,
    0x00200000l, 0x00008000l, 0x08000020l, 0x08208020l,
    0x00008020l, 0x08000000l, 0x00000000l, 0x00208000l,
    0x08200020l, 0x08008020l, 0x08008000l, 0x00200020l,
    0x08208000l, 0x00000020l, 0x00200020l, 0x08008000l,
    0x08208020l, 0x00200000l, 0x08200000l, 0x08000020l,
    0x00208000l, 0x00008020l, 0x08008020l, 0x08200000l,
    0x00000020l, 0x08208000l, 0x00208020l, 0x00000000l,
    0x08000000l, 0x08200020l, 0x00008000l, 0x00208020l
  }
};

/* sk.h */
/* Copyright (C) 1993 Eric Young */
static UINT4 des_skb[8][64]={
  /* for C bits (numbered as per FIPS 46) 1 2 3 4 5 6 */
  {
    0x00000000l,0x00000010l,0x20000000l,0x20000010l,
    0x00010000l,0x00010010l,0x20010000l,0x20010010l,
    0x00000800l,0x00000810l,0x20000800l,0x20000810l,
    0x00010800l,0x00010810l,0x20010800l,0x20010810l,
    0x00000020l,0x00000030l,0x20000020l,0x20000030l,
    0x00010020l,0x00010030l,0x20010020l,0x20010030l,
    0x00000820l,0x00000830l,0x20000820l,0x20000830l,
    0x00010820l,0x00010830l,0x20010820l,0x20010830l,
    0x00080000l,0x00080010l,0x20080000l,0x20080010l,
    0x00090000l,0x00090010l,0x20090000l,0x20090010l,
    0x00080800l,0x00080810l,0x20080800l,0x20080810l,
    0x00090800l,0x00090810l,0x20090800l,0x20090810l,
    0x00080020l,0x00080030l,0x20080020l,0x20080030l,
    0x00090020l,0x00090030l,0x20090020l,0x20090030l,
    0x00080820l,0x00080830l,0x20080820l,0x20080830l,
    0x00090820l,0x00090830l,0x20090820l,0x20090830l,
  },
  /* for C bits (numbered as per FIPS 46) 7 8 10 11 12 13 */
  {
    0x00000000l,0x02000000l,0x00002000l,0x02002000l,
    0x00200000l,0x02200000l,0x00202000l,0x02202000l,
    0x00000004l,0x02000004l,0x00002004l,0x02002004l,
    0x00200004l,0x02200004l,0x00202004l,0x02202004l,
    0x00000400l,0x02000400l,0x00002400l,0x02002400l,
    0x00200400l,0x02200400l,0x00202400l,0x02202400l,
    0x00000404l,0x02000404l,0x00002404l,0x02002404l,
    0x00200404l,0x02200404l,0x00202404l,0x02202404l,
    0x10000000l,0x12000000l,0x10002000l,0x12002000l,
    0x10200000l,0x12200000l,0x10202000l,0x12202000l,
    0x10000004l,0x12000004l,0x10002004l,0x12002004l,
    0x10200004l,0x12200004l,0x10202004l,0x12202004l,
    0x10000400l,0x12000400l,0x10002400l,0x12002400l,
    0x10200400l,0x12200400l,0x10202400l,0x12202400l,
    0x10000404l,0x12000404l,0x10002404l,0x12002404l,
    0x10200404l,0x12200404l,0x10202404l,0x12202404l,
  },
  /* for C bits (numbered as per FIPS 46) 14 15 16 17 19 20 */
  {
    0x00000000l,0x00000001l,0x00040000l,0x00040001l,
    0x01000000l,0x01000001l,0x01040000l,0x01040001l,
    0x00000002l,0x00000003l,0x00040002l,0x00040003l,
    0x01000002l,0x01000003l,0x01040002l,0x01040003l,
    0x00000200l,0x00000201l,0x00040200l,0x00040201l,
    0x01000200l,0x01000201l,0x01040200l,0x01040201l,
    0x00000202l,0x00000203l,0x00040202l,0x00040203l,
    0x01000202l,0x01000203l,0x01040202l,0x01040203l,
    0x08000000l,0x08000001l,0x08040000l,0x08040001l,
    0x09000000l,0x09000001l,0x09040000l,0x09040001l,
    0x08000002l,0x08000003l,0x08040002l,0x08040003l,
    0x09000002l,0x09000003l,0x09040002l,0x09040003l,
    0x08000200l,0x08000201l,0x08040200l,0x08040201l,
    0x09000200l,0x09000201l,0x09040200l,0x09040201l,
    0x08000202l,0x08000203l,0x08040202l,0x08040203l,
    0x09000202l,0x09000203l,0x09040202l,0x09040203l,
  },
  /* for C bits (numbered as per FIPS 46) 21 23 24 26 27 28 */
  {
    0x00000000l,0x00100000l,0x00000100l,0x00100100l,
    0x00000008l,0x00100008l,0x00000108l,0x00100108l,
    0x00001000l,0x00101000l,0x00001100l,0x00101100l,
    0x00001008l,0x00101008l,0x00001108l,0x00101108l,
    0x04000000l,0x04100000l,0x04000100l,0x04100100l,
    0x04000008l,0x04100008l,0x04000108l,0x04100108l,
    0x04001000l,0x04101000l,0x04001100l,0x04101100l,
    0x04001008l,0x04101008l,0x04001108l,0x04101108l,
    0x00020000l,0x00120000l,0x00020100l,0x00120100l,
    0x00020008l,0x00120008l,0x00020108l,0x00120108l,
    0x00021000l,0x00121000l,0x00021100l,0x00121100l,
    0x00021008l,0x00121008l,0x00021108l,0x00121108l,
    0x04020000l,0x04120000l,0x04020100l,0x04120100l,
    0x04020008l,0x04120008l,0x04020108l,0x04120108l,
    0x04021000l,0x04121000l,0x04021100l,0x04121100l,
    0x04021008l,0x04121008l,0x04021108l,0x04121108l,
  },
  /* for D bits (numbered as per FIPS 46) 1 2 3 4 5 6 */
  {
    0x00000000l,0x10000000l,0x00010000l,0x10010000l,
    0x00000004l,0x10000004l,0x00010004l,0x10010004l,
    0x20000000l,0x30000000l,0x20010000l,0x30010000l,
    0x20000004l,0x30000004l,0x20010004l,0x30010004l,
    0x00100000l,0x10100000l,0x00110000l,0x10110000l,
    0x00100004l,0x10100004l,0x00110004l,0x10110004l,
    0x20100000l,0x30100000l,0x20110000l,0x30110000l,
    0x20100004l,0x30100004l,0x20110004l,0x30110004l,
    0x00001000l,0x10001000l,0x00011000l,0x10011000l,
    0x00001004l,0x10001004l,0x00011004l,0x10011004l,
    0x20001000l,0x30001000l,0x20011000l,0x30011000l,
    0x20001004l,0x30001004l,0x20011004l,0x30011004l,
    0x00101000l,0x10101000l,0x00111000l,0x10111000l,
    0x00101004l,0x10101004l,0x00111004l,0x10111004l,
    0x20101000l,0x30101000l,0x20111000l,0x30111000l,
    0x20101004l,0x30101004l,0x20111004l,0x30111004l,
  },
  /* for D bits (numbered as per FIPS 46) 8 9 11 12 13 14 */
  {
    0x00000000l,0x08000000l,0x00000008l,0x08000008l,
    0x00000400l,0x08000400l,0x00000408l,0x08000408l,
    0x00020000l,0x08020000l,0x00020008l,0x08020008l,
    0x00020400l,0x08020400l,0x00020408l,0x08020408l,
    0x00000001l,0x08000001l,0x00000009l,0x08000009l,
    0x00000401l,0x08000401l,0x00000409l,0x08000409l,
    0x00020001l,0x08020001l,0x00020009l,0x08020009l,
    0x00020401l,0x08020401l,0x00020409l,0x08020409l,
    0x02000000l,0x0A000000l,0x02000008l,0x0A000008l,
    0x02000400l,0x0A000400l,0x02000408l,0x0A000408l,
    0x02020000l,0x0A020000l,0x02020008l,0x0A020008l,
    0x02020400l,0x0A020400l,0x02020408l,0x0A020408l,
    0x02000001l,0x0A000001l,0x02000009l,0x0A000009l,
    0x02000401l,0x0A000401l,0x02000409l,0x0A000409l,
    0x02020001l,0x0A020001l,0x02020009l,0x0A020009l,
    0x02020401l,0x0A020401l,0x02020409l,0x0A020409l,
  },
  /* for D bits (numbered as per FIPS 46) 16 17 18 19 20 21 */
  {
    0x00000000l,0x00000100l,0x00080000l,0x00080100l,
    0x01000000l,0x01000100l,0x01080000l,0x01080100l,
    0x00000010l,0x00000110l,0x00080010l,0x00080110l,
    0x01000010l,0x01000110l,0x01080010l,0x01080110l,
    0x00200000l,0x00200100l,0x00280000l,0x00280100l,
    0x01200000l,0x01200100l,0x01280000l,0x01280100l,
    0x00200010l,0x00200110l,0x00280010l,0x00280110l,
    0x01200010l,0x01200110l,0x01280010l,0x01280110l,
    0x00000200l,0x00000300l,0x00080200l,0x00080300l,
    0x01000200l,0x01000300l,0x01080200l,0x01080300l,
    0x00000210l,0x00000310l,0x00080210l,0x00080310l,
    0x01000210l,0x01000310l,0x01080210l,0x01080310l,
    0x00200200l,0x00200300l,0x00280200l,0x00280300l,
    0x01200200l,0x01200300l,0x01280200l,0x01280300l,
    0x00200210l,0x00200310l,0x00280210l,0x00280310l,
    0x01200210l,0x01200310l,0x01280210l,0x01280310l,
  },
  /* for D bits (numbered as per FIPS 46) 22 23 24 25 27 28 */
  {
    0x00000000l,0x04000000l,0x00040000l,0x04040000l,
    0x00000002l,0x04000002l,0x00040002l,0x04040002l,
    0x00002000l,0x04002000l,0x00042000l,0x04042000l,
    0x00002002l,0x04002002l,0x00042002l,0x04042002l,
    0x00000020l,0x04000020l,0x00040020l,0x04040020l,
    0x00000022l,0x04000022l,0x00040022l,0x04040022l,
    0x00002020l,0x04002020l,0x00042020l,0x04042020l,
    0x00002022l,0x04002022l,0x00042022l,0x04042022l,
    0x00000800l,0x04000800l,0x00040800l,0x04040800l,
    0x00000802l,0x04000802l,0x00040802l,0x04040802l,
    0x00002800l,0x04002800l,0x00042800l,0x04042800l,
    0x00002802l,0x04002802l,0x00042802l,0x04042802l,
    0x00000820l,0x04000820l,0x00040820l,0x04040820l,
    0x00000822l,0x04000822l,0x00040822l,0x04040822l,
    0x00002820l,0x04002820l,0x00042820l,0x04042820l,
    0x00002822l,0x04002822l,0x00042822l,0x04042822l,
  }
};

#if 0
/* podd.h */
/* Copyright (C) 1993 Eric Young */
static unsigned char odd_parity[256]={
  1,  1,  2,  2,  4,  4,  7,  7,  8,  8, 11, 11, 13, 13, 14, 14,
 16, 16, 19, 19, 21, 21, 22, 22, 25, 25, 26, 26, 28, 28, 31, 31,
 32, 32, 35, 35, 37, 37, 38, 38, 41, 41, 42, 42, 44, 44, 47, 47,
 49, 49, 50, 50, 52, 52, 55, 55, 56, 56, 59, 59, 61, 61, 62, 62,
 64, 64, 67, 67, 69, 69, 70, 70, 73, 73, 74, 74, 76, 76, 79, 79,
 81, 81, 82, 82, 84, 84, 87, 87, 88, 88, 91, 91, 93, 93, 94, 94,
 97, 97, 98, 98,100,100,103,103,104,104,107,107,109,109,110,110,
112,112,115,115,117,117,118,118,121,121,122,122,124,124,127,127,
128,128,131,131,133,133,134,134,137,137,138,138,140,140,143,143,
145,145,146,146,148,148,151,151,152,152,155,155,157,157,158,158,
161,161,162,162,164,164,167,167,168,168,171,171,173,173,174,174,
176,176,179,179,181,181,182,182,185,185,186,186,188,188,191,191,
193,193,194,194,196,196,199,199,200,200,203,203,205,205,206,206,
208,208,211,211,213,213,214,214,217,217,218,218,220,220,223,223,
224,224,227,227,229,229,230,230,233,233,234,234,236,236,239,239,
241,241,242,242,244,244,247,247,248,248,251,251,253,253,254,254};

int des_check_key=0;
static int check_parity();

void des_set_odd_parity(key)
des_cblock *key;
{
	int i;

	for (i=0; i<DES_KEY_SZ; i++)
		(*key)[i]=odd_parity[(*key)[i]];
}

static int check_parity(key)
des_cblock *key;
{
	int i;

	for (i=0; i<DES_KEY_SZ; i++)
		{
		if ((*key)[i] != odd_parity[(*key)[i]])
			return(0);
		}
	return(1);
}

#endif

/* NOW DEFINED IN des_local.h
 * #define PERM_OP(a,b,t,n,m) ((t)=((((a)>>(n))^(b))&(m)),\
 * 	(b)^=(t),\
 * 	(a)=((a)^((t)<<(n))))
 */

#define HPERM_OP(a,t,n,m) ((t)=((((a)<<(16-(n)))^(a))&(m)),\
	(a)=(a)^(t)^(t>>(16-(n))))

static char shifts2[16]={0,0,1,1,1,1,1,1,0,1,1,1,1,1,1,0};


void DESDecryptInit (context, key)
DES_CTX *context;
POINTER key;
{
  register UINT4 *pKsFront, *pKsBack, ksTemp;
  
  DESEncryptInit (context, key);
  pKsFront = &(context->keyTable[0]);
  pKsBack = &(context->keyTable[2*ITERATIONS - 2]);
  for ( ; pKsFront < pKsBack ; pKsFront += 2, pKsBack -= 2)
  {
    ksTemp = pKsFront[0];
	pKsFront[0] = pKsBack[0];
	pKsBack[0] = ksTemp;
    ksTemp = pKsFront[1];
	pKsFront[1] = pKsBack[1];
	pKsBack[1] = ksTemp;
  }
}


void DESEncryptInit (context, keystr)
DES_CTX *context;
POINTER keystr;
{
	register UINT4 c,d,t,s;
	register unsigned char *in;
	register UINT4 *k;
	register int i;

	k = (UINT4 *)&(context->keyTable[0]);
	in = (unsigned char *)keystr;

	c2l(in,c);
	c2l(in,d);

	/* I now do it in 47 simple operations :-)
	 * Thanks to John Fletcher (john_fletcher@lccmail.ocf.llnl.gov)
	 * for the inspiration. :-) */
	PERM_OP (d,c,t,4,0x0f0f0f0fl);
	HPERM_OP(c,t,-2,0xcccc0000l);
	HPERM_OP(d,t,-2,0xcccc0000l);
	PERM_OP (d,c,t,1,0x55555555l);
	PERM_OP (c,d,t,8,0x00ff00ffl);
	PERM_OP (d,c,t,1,0x55555555l);
	d=	(((d&0x000000ffl)<<16)| (d&0x0000ff00l)     |
		 ((d&0x00ff0000l)>>16)|((c&0xf0000000l)>>4));
	c&=0x0fffffffl;

	for (i=0; i<ITERATIONS; i++)
	{
		if (shifts2[i])
			{ c=((c>>2)|(c<<26)); d=((d>>2)|(d<<26)); }
		else
			{ c=((c>>1)|(c<<27)); d=((d>>1)|(d<<27)); }
		c&=0x0fffffffl;
		d&=0x0fffffffl;
		/* could be a few less shifts but I am to lazy at this
		 * point in time to investigate */
		s=	des_skb[0][ (int)((c)&0x3f) ]|
			des_skb[1][ (int)(((c>> 6)&0x03)|((c>> 7)&0x3c)) ]|
			des_skb[2][ (int)(((c>>13)&0x0f)|((c>>14)&0x30)) ]|
			des_skb[3][ (int)(((c>>20)&0x01)|((c>>21)&0x06) |
						  ((c>>22)&0x38)) ];
		t=	des_skb[4][ (int)((d)&0x3f) ]|
			des_skb[5][(int) (((d>> 7)&0x03)|((d>> 8)&0x3c)) ]|
			des_skb[6][ (int) ((d>>15)&0x3f) ]|
			des_skb[7][ (int) (((d>>21)&0x0f)|((d>>22)&0x30)) ];

		/* table contained 0213 4657 */
		*(k++)=((t<<16)|(s&0x0000ffffl))&0xffffffffl;
		s=     ((s>>16)|(t&0xffff0000l));
		
		s=(s<<4)|(s>>28);
		*(k++)=s&0xffffffffl;
	}
}


/* Do an 8-byte DES encryption or decryption.
 */
void DES (context, out, in)
  POINTER context;
  unsigned char *in,*out;
{
	register UINT4 l,r,t,u;
#ifdef ALT_ECB
	register unsigned char *des_SP=(unsigned char *)des_SPtrans;
#endif
	register int i;
	register UINT4 *s;

	c2l(in,l);
	c2l(in,r);

	IP(l,r,t);
	/* Things have been modified so that the initial rotate is
	 * done outside the loop.  This required the
	 * des_SPtrans values in sp.h to be rotated 1 bit to the right.
	 * One perl script later and things have a 5% speed up on a sparc2.
	 * Thanks to Richard Outerbridge <71755.204@CompuServe.COM>
	 * for pointing this out. */
	t=(r<<1)|(r>>31);
	r=(l<<1)|(l>>31);
	l=t;

	/* clear the top bits on machines with 8byte longs */
	l&=0xffffffffl;
	r&=0xffffffffl;

	s=((DES_CTX *)context)->keyTable;
	/* I don't know if it is worth the effort of loop unrolling the
	 * inner loop */
	for (i=0; i<32; i+=4)
	{
		D_ENCRYPT(l,r,i+0); /*  1 */
		D_ENCRYPT(r,l,i+2); /*  2 */
	}
	l=(l>>1)|(l<<31);
	r=(r>>1)|(r<<31);
	/* clear the top bits on machines with 8byte longs */
	l&=0xffffffffl;
	r&=0xffffffffl;

	FP(r,l,t);

	l2c(l,out);
	l2c(r,out);
}
